name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
    - name: Install pre-commit
      run: pip install pre-commit
    - name: Run pre-commit
      run: pre-commit run --all-files
    - name: Run Gitleaks (Secrets Scan)
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Install Checkov
      run: pip install checkov
    - name: Create threat_modelling directory
      run: mkdir -p threat_modelling/reports
    - name: Run SAST and Threat Modeling
      run: |
        # Run Checkov with JSON output
        checkov -d . --framework terraform --output json --output-file-path threat_modelling/reports

        # Convert Checkov output to threat report format
        python3 .github/scripts/generate_threat_report.py
      continue-on-error: true
    - name: Upload Threat Report
      uses: actions/upload-artifact@v3
      with:
        name: threat-report
        path: threat_modelling/reports/pr-threats.json
    - name: Generate Threat Summary
      run: |
        if [ -f threat_modelling/reports/pr-threats.json ]; then
          python3 .github/scripts/generate_threat_summary.py > threat_modelling/reports/threat-summary.md
        fi
    - name: Create GitHub Issues for Threats
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const threats = JSON.parse(fs.readFileSync('threat_modelling/reports/pr-threats.json'));

          for (const threat of threats.critical || []) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CRITICAL] ${threat.title}`,
              body: threat.description,
              labels: ['security', 'critical', 'threat-model']
            });
          }

          for (const threat of threats.high || []) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[HIGH] ${threat.title}`,
              body: threat.description,
              labels: ['security', 'high', 'threat-model']
            });
          }
    - name: NIST Compliance Check
      run: echo "NIST compliance validation integrated with Checkov policies"
    - name: Run CIS Compliance Scan
      run: |
        go test -v ./tests/integration/gcp -run TestCISCompliance
    - name: Run Semgrep
      uses: semgrep/semgrep-action@v1
      with:
        config: "p/terraform"
    - name: Set up OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: latest
    - name: Initialize
      run: tofu init
    - name: Validate
      run: tofu validate
    - name: Plan
      run: tofu plan -no-color
