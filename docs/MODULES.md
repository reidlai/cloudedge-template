# Deployment Structure

This document describes the OpenTofu deployment structure, state management, and dependency relationships.

## Directory Structure

```
deploy/opentofu/
└── gcp/
    ├── project-singleton/     # Layer 1: Project resources
    │   ├── main.tf            # Backend config, providers
    │   ├── project-singleton.tf  # Billing, logging, APIs
    │   ├── variables.tf
    │   └── outputs.tf
    │
    ├── demo-web-app/          # Layer 2: Application VPC
    │   ├── main.tf            # Backend config, providers
    │   ├── demo-web-app.tf    # VPC, Cloud Run, Internal ALB, PSC
    │   ├── variables.tf
    │   └── outputs.tf
    │
    └── core/                  # Layer 3: Ingress infrastructure
        ├── main.tf            # Backend config, providers
        ├── core.tf            # Ingress VPC, WAF, External LB, PSC, DNS
        ├── variables.tf
        └── outputs.tf
```

## Deployment Order

Configurations must be deployed in order due to remote state dependencies:

```
1. project-singleton  ─────────────────────────────────────┐
   │                                                        │
   │ Outputs:                                               │
   │ - project_id                                           │
   │ - enable_logging                                       │
   │                                                        │
   └──► Remote State: ${project_id}-singleton              │
                                                            │
2. demo-web-app  ──────────────────────────────────────────┤
   │                                                        │
   │ Reads:                                                 │
   │ - project-singleton (for enable_logging)              │
   │                                                        │
   │ Outputs:                                               │
   │ - web_app_psc_service_attachment_self_link            │
   │                                                        │
   └──► Remote State: demo-web-app                         │
                                                            │
3. core  ──────────────────────────────────────────────────┘
   │
   │ Reads:
   │ - project-singleton (for enable_logging)
   │ - demo-web-app (for psc_service_attachment_self_link)
   │
   └──► Remote State: ${project_id}-core
```

## State Management

Each configuration uses GCS backend with separate state files:

| Configuration | State Bucket | State Prefix |
|---------------|--------------|--------------|
| project-singleton | `${project_id}-tfstate` | `${project_id}-singleton` |
| demo-web-app | `${project_id}-tfstate` | `demo-web-app` |
| core | `${project_id}-tfstate` | `${project_id}-core` |

### Backend Configuration

All configurations use the same backend pattern:

```hcl
terraform {
  backend "gcs" {}
}
```

Configuration is provided via `backend-config.hcl` generated by `scripts/setup-backend.sh`.

### Remote State References

**demo-web-app reads from project-singleton**:

```hcl
data "terraform_remote_state" "singleton" {
  backend = "gcs"
  config = {
    bucket = "${local.project_id}-tfstate"
    prefix = "${local.project_id}-singleton"
  }
}
```

**core reads from both**:

```hcl
data "terraform_remote_state" "singleton" {
  backend = "gcs"
  config = {
    bucket = "${local.project_id}-tfstate"
    prefix = "${local.project_id}-singleton"
  }
}

data "terraform_remote_state" "demo_web_app" {
  backend = "gcs"
  config = {
    bucket = "${local.demo_web_app_project_id}-tfstate"
    prefix = "demo-web-app"
  }
}
```

## Dependency Graph

```
                    +--------------------+
                    | project-singleton  |
                    +--------------------+
                    | - Billing budget   |
                    | - Logging bucket   |
                    | - API enablement   |
                    +----------+---------+
                               |
                               | enable_logging
                               |
              +----------------+----------------+
              |                                 |
              v                                 v
    +--------------------+            +--------------------+
    |   demo-web-app     |            |        core        |
    +--------------------+            +--------------------+
    | - Web VPC          |            | - Ingress VPC      |
    | - Cloud Run        |            | - Cloud Armor WAF  |
    | - Internal ALB     |            | - External LB      |
    | - PSC Producer     |            | - PSC Consumer     |
    +---------+----------+            | - Cloudflare DNS   |
              |                       +---------+----------+
              |                                 |
              | psc_service_attachment_self_link|
              |                                 |
              +---------------------------------+
```

## Output Wiring

### project-singleton Outputs

| Output | Consumers | Usage |
|--------|-----------|-------|
| `enable_logging` | demo-web-app, core | Determines if logging resources created |
| `project_id` | All | Project identifier |
| `billing_budget_id` | None | Reference only |

### demo-web-app Outputs

| Output | Consumers | Usage |
|--------|-----------|-------|
| `web_app_psc_service_attachment_self_link` | core | PSC NEG target |

### core Outputs

| Output | Consumers | Usage |
|--------|-----------|-------|
| `load_balancer_ip` | External | Access endpoint |
| `waf_policy_id` | None | Reference only |
| `ingress_vpc_id` | None | Reference only |

## Future Expansion

### Additional Application VPCs

To add new application backends:

1. Create new configuration: `deploy/opentofu/gcp/app-vpc/`
2. Follow demo-web-app pattern with PSC service attachment
3. Add PSC consumer in core configuration
4. Update URL map for routing

```
deploy/opentofu/gcp/
├── project-singleton/
├── demo-web-app/       # Existing
├── app1-vpc/           # New application
├── app2-vpc/           # New application
└── core/               # Updated with PSC consumers
```

### Multi-Region

For disaster recovery:

```
deploy/opentofu/gcp/
├── project-singleton/
├── demo-web-app/
├── core/
│
└── regions/
    ├── region-a/       # Primary region
    │   └── core/
    └── region-b/       # Secondary region
        └── core/
```

### Multi-Cloud

For AWS/Azure expansion:

```
deploy/opentofu/
├── gcp/                # Current
│   ├── project-singleton/
│   ├── demo-web-app/
│   └── core/
├── aws/                # Future
│   ├── account-singleton/
│   ├── demo-web-app/
│   └── core/
└── azure/              # Future
    ├── subscription-singleton/
    ├── demo-vnet/
    └── core/
```

## Deployment Commands

### Individual Configuration Deployment

```bash
# Deploy project-singleton
cd deploy/opentofu/gcp/project-singleton
tofu init -backend-config=backend-config.hcl
tofu apply

# Deploy demo-web-app
cd ../demo-web-app
tofu init -backend-config=backend-config.hcl
tofu apply

# Deploy core
cd ../core
tofu init -backend-config=backend-config.hcl
tofu apply
```

### Scripted Deployment

```bash
# Full deployment (handles order automatically)
./scripts/deploy.sh

# Teardown (reverse order)
./scripts/teardown.sh
```

## Troubleshooting

### State Lock Issues

```bash
# Force unlock (use with caution)
tofu force-unlock <lock-id>
```

### Remote State Not Found

Ensure previous configuration is deployed:

```bash
# Check state exists
gsutil ls gs://${project_id}-tfstate/
```

### Dependency Cycle

If outputs change, may need to re-apply in order:

```bash
cd project-singleton && tofu apply
cd ../demo-web-app && tofu apply
cd ../core && tofu apply
```
